#!/bin/sh

ssh="ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
scp="scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"

# Wait until box is up and running
until $scp ~/.ssh/id_rsa.pub  root@${1}:/etc/dropbear/authorized_keysssh; do
   sleep 2
done

$ssh root@$1 rm /tmp/\*.ipk

cd mr3020-packages
$scp kmod-*cp437*ipk kmod-lib-crc16_*_ar71xx.ipk kmod-scsi-core_*_ar71xx.ipk kmod-usb-storage-extras_*_ar71xx.ipk kmod-usb-storage_*_ar71xx.ipk libuuid_*_ar71xx.ipk libblkid_*_ar71xx.ipk libcom_err_*_ar71xx.ipk libpthread_*_ar71xx.ipk libext2fs_*_ar71xx.ipk e2fsprogs_*_ar71xx.ipk fdisk_*_ar71xx.ipk usbreset*ipk root@${1}:/tmp
cd ..

$ssh root@$1 "( opkg install /tmp/*.ipk ; rm /tmp/*.ipk )"


$scp mr3020-scripts/run-fdisk.sh root@${1}:/tmp
$ssh root@${1} /tmp/run-fdisk.sh

#!/bin/sh
$ssh root@${1} rm /tmp/*.ipk
$scp mr3020-scripts/prepare-filesystems mr3020-packages/block-mount_*_ar71xx.ipk mr3020-packages/kmod-fs-*_ar71xx.ipk mr3020-packages/blkid* mr3020-packages/swap* mr3020-packages/librt* root@${1}:/tmp
$ssh root@${1} /tmp/prepare-filesystems


#!/bin/sh
$ssh root@${1} rm /tmp/*.ipk
mkdir -p tmp

  apE=`dd if=/dev/urandom bs=5 count=1 | hexdump -e '1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X"'`
meshE=`dd if=/dev/urandom bs=5 count=1 | hexdump -e '1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X" ":" 1/1 "%02X"'

#mesh ip is last 3 of mac munched to 10.64/10
  meship=`echo $meshE |awk -F: '{  p3=("0x" substr($3,0,2))+0; p4=("0x" substr($4,0,2))+0  ;\
	 p5=("0x" substr($5,0,2))+0; printf "%d.%d.%d",(64+p3%4),p4,p5 }' `
 
# AP IP is last 2 of mac munged to fit 172.16-31
  apip=`echo $apE |awk -F: '{ p4=("0x" substr($4,0,2))+0 ; p5=("0x" substr($5,0,2))+0  ;printf "%d.%d",(16+p4%16),p5 }' `

echo $meship $meshE $apE $apip

sed -e s/MESHIP/$meship/g -e s/APIP/$apip/g -e s/MESHETHER/$meshE/g  -e s/APETHER/$apE/g < mr3020-files/network > tmp/network.$$

cat tmp/network.$$
$scp tmp/network.$$ root@${1}:/etc/config/network
rm tmp/network.$$

wlanmac=`$ssh root@{1} "cat /sys/class/ieee80211/phy0/macaddress"`
sed -e s/WIMAC/$wlanmac/g < mr3020-files/wireless > tmp/wireless.$$ 
$scp tmp/wireless.$$ root@${1}:/etc/config/wireless

cd mr3020-files
$ssh root@${1} mkdir -p /etc/serval /serval /serval-var /etc/hotplug.d/button
$scp system dhcp root@${1}:/etc/config/
$scp profile root@${1}:/etc/
$scp S94servald root@${1}:/etc/rc.d/
$scp hotplug2.rules inittab root@${1}:/etc/
$scp buttons root@${1}:/etc/hotplug.d/button/
$scp runservald serval.conf root@${1}:/etc/serval/
$ssh root@${1} "( umount /serval ; mount /dev/sda2 /serval )"
$scp servald.me root@${1}:/serval/servald
$scp servald.me root@${1}:/serval/servald.factory
$scp monitor-wifi root@${1}:/serval/sbin/monitor-wifi
$ssh root@${1} "( umount /serval )"
$ssh root@${1} "( umount /serval-var ; mount /dev/sda3 /serval-var ; mkdir -p /serval-var/log /serval-var/rhizome )"
$ssh root@${1} "( umount /serval-var )"
cd ..

$ssh root@${1} "( mount /dev/sda2 /serval )"
$scp mr3020-files/extra-files-serval.tgz root@${1}:/serval/s.tgz
$scp mr3020-files/extra-files-usr.tgz root@${1}:/serval/u.tgz
$ssh root@${1} "( cd /serval ; tar zxvf s.tgz ; rm s.tgz ; cd /usr ; tar zxvf /serval/u.tgz ; rm /serval/u.tgz ; umount /serval )"

cd mr3020-packages
$ssh root@${1} "( rm /tmp/*.ipk )"
$scp kmod-fs-vfat* kmod-fs-msdos* root@${1}:/tmp
$ssh root@$1 "( opkg install /tmp/*.ipk ; rm /tmp/*.ipk ; mount /dev/sda2 /serval ; /serval/sbin/mkdosfs /dev/sda1 ; mkdir /dos ; umount /serval)"
cd ..

$ssh -o TCPKeepAlive=yes -o ServerAliveInterval=5 root@${1} reboot

echo "Waiting for reboot to complete."
# Wait until box is up and running
until $ssh root@${1} /bin/true; do
   sleep 2
done
